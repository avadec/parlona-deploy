# docker-compose.yml (Local Dev on Mac)
# Usage:
#   docker compose up --build -d
#   docker compose logs -f call_analytics_api
#   docker compose down

services:
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --protected-mode yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - parlona_network
    restart: unless-stopped

  db:
    image: postgres:16
    environment:
      # Keep these explicit for clarity in local dev:
      POSTGRES_USER: ${POSTGRES_USER:-parlonacore}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-parlonacore}
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - parlona_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-parlonacore} -d ${POSTGRES_DB:-parlonacore}"]
      interval: 5s
      timeout: 3s
      retries: 30

  call_analytics_api:
    image: parlona/voicecore-api:1.2.0
    env_file:
      - .env
    environment:
      SERVICE_NAME: call_analytics_api
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0

      # Keep both DSN styles available; your code currently uses different ones in different files.
      # If your app expects one конкретно — it will just read the one it uses.
      POSTGRES_DSN: postgresql+asyncpg://${POSTGRES_USER:-parlonacore}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-parlonacore}
      POSTGRES_DSN_PSYCOPG: postgresql+psycopg://${POSTGRES_USER:-parlonacore}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-parlonacore}

      RUN_DB_MIGRATIONS: "1"
      STORAGE_DIR: /app/storage
    ports:
      - "8080:8080"
    volumes:
      # Persistent runtime storage
      - audio_storage:/app/storage
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - parlona_network
    restart: unless-stopped

  stt_service:
    image: parlona/voicecore-stt:1.2.0
    env_file:
      - .env
    environment:
      SERVICE_NAME: stt_service
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0

      STORAGE_DIR: /app/storage
      STT_DIARIZATION_MODE: "stereo_channels"
      STT_STEREO_SPEAKER_MAPPING: "0:manager,1:customer"

      # Force CPU mode for development
      STT_ENABLE_GPU: "0"
      FORCE_CPU: "1"
      STT_MODEL_NAME: "Systran/faster-whisper-small"

      WHISPER_MODEL_DIR: /models/whisper
      WHISPER_LOCAL_ONLY: "1"
      HF_HUB_OFFLINE: "0"
    volumes:
      # Shared persistent storage for audio + artifacts
      - audio_storage:/app/storage

      # Persistent model cache on host
      - ./models/whisper_cache:/models/whisper
    depends_on:
      redis:
        condition: service_started
    networks:
      - parlona_network
    restart: unless-stopped
    # Reduced memory limit for tiny model
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  summary_service:
    image: parlona/voicecore-summary:1.2.0
    env_file:
      - .env
    environment:
      SERVICE_NAME: summary_service
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
    depends_on:
      redis:
        condition: service_started
    networks:
      - parlona_network
    restart: unless-stopped

  postprocess_service:
    image: parlona/voicecore-postprocess:1.2.0
    env_file:
      - .env
    environment:
      SERVICE_NAME: postprocess_service
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0

      POSTGRES_DSN: postgresql+asyncpg://${POSTGRES_USER:-parlonacore}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-parlonacore}
      POSTGRES_DSN_PSYCOPG: postgresql+psycopg://${POSTGRES_USER:-parlonacore}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-parlonacore}

      RUN_DB_MIGRATIONS: "1"
      STORAGE_DIR: /app/storage
    volumes:
      # Persistent runtime storage
      - audio_storage:/app/storage
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - parlona_network
    restart: unless-stopped

  frontend:
    image: parlona/voicecore-frontend:1.2.0
    env_file:
      - .env
    environment:
      # Production API URL - update to your domain
      NEXT_PUBLIC_API_BASE_URL: http://call_analytics_api:8080
      NEXT_PUBLIC_CALL_API_KEY: ${CALL_API_KEY}
      API_BASE_URL: http://call_analytics_api:8080
      CALL_API_KEY: ${CALL_API_KEY}
    ports:
      - "3000:3000"
    depends_on:
      call_analytics_api:
        condition: service_started
    networks:
      - parlona_network
    restart: unless-stopped

volumes:
  redis_data:
  postgres_data:
  audio_storage:

networks:
  parlona_network:
    driver: bridge