# version: "3.9"  # Removed due to deprecation warning

services:
  redis:
    image: redis:7
    # Security: Only expose Redis internally within the Docker network
    # Remove public port exposure to prevent unauthorized access
    env_file:
      - .env
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}", "--protected-mode", "yes"]
    networks:
      - parlona_network
    restart: unless-stopped

  db:
    image: postgres:16
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - parlona_network
    restart: unless-stopped

  call_analytics_api:
    image: parlona/parlonacore-api:${PARLONACORE_VERSION}
    env_file:
      - .env
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      POSTGRES_DSN: postgresql+psycopg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      RUN_DB_MIGRATIONS: "1"
      SERVICE_NAME: call_analytics_api
      STORAGE_DIR: /app/storage
    depends_on:
      - redis
      - db
    ports:
      - "8080:8080"
    volumes:
      - audio_storage:/app/storage
    networks:
      - parlona_network
    restart: unless-stopped

  stt_service:
    image: parlona/parlonacore-stt:${PARLONACORE_VERSION}
    env_file:
      - .env
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      SERVICE_NAME: stt_service
      STORAGE_DIR: /app/storage
      STT_DIARIZATION_MODE: "stereo_channels"
      STT_STEREO_SPEAKER_MAPPING: "0:manager,1:customer"
      WHISPER_MODEL_DIR: /models/whisper
      WHISPER_LOCAL_ONLY: "0"     # Set to "1" for offline mode after warming cache
      HF_HUB_OFFLINE: "0"         # Set to "1" for offline mode after warming cache
    depends_on:
      - redis
    volumes:
      - audio_storage:/app/storage
      - ./models/whisper_cache:/models/whisper
    # Uncomment the following line on GPU hosts with nvidia-container-toolkit installed:
    # gpus: all
    networks:
      - parlona_network
    restart: unless-stopped

  summary_service:
    image: parlona/parlonacore-summary:${PARLONACORE_VERSION}
    env_file:
      - .env
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      SERVICE_NAME: summary_service
    depends_on:
      - redis
    networks:
      - parlona_network
    restart: unless-stopped

  postprocess_service:
    image: parlona/parlonacore-postprocess:${PARLONACORE_VERSION}
    env_file:
      - .env
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      POSTGRES_DSN: postgresql+psycopg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      RUN_DB_MIGRATIONS: "1"
      SERVICE_NAME: postprocess_service
    depends_on:
      - redis
      - db
    networks:
      - parlona_network
    restart: unless-stopped

volumes:
  audio_storage:
  postgres_data:

networks:
  parlona_network:
    driver: bridge